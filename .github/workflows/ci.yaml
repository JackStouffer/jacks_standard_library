name: CI

on:
  push:
  pull_request:

jobs:
  build-test:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runs_on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- Windows x64 ---
          - name: windows-msvc
            runs_on: windows-latest
            compiler: msvc
          - name: windows-clang
            runs_on: windows-latest
            compiler: clang

          # --- macOS ARM (Apple Silicon) ---
          - name: macos-arm-clang
            runs_on: macos-14
            compiler: clang
          - name: macos-arm-gcc
            runs_on: macos-14
            compiler: gcc

          # --- Linux x86_64 ---
          - name: linux-x64-gcc
            runs_on: ubuntu-latest
            compiler: gcc
          - name: linux-x64-clang
            runs_on: ubuntu-latest
            compiler: clang

          # --- Linux ARM64 (public repos only) ---
          - name: linux-arm64-gcc
            runs_on: ubuntu-24.04-arm
            compiler: gcc
          - name: linux-arm64-clang
            runs_on: ubuntu-24.04-arm
            compiler: clang

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- Set up compilers ----------
      - name: Set up MSVC (Windows)
        if: runner.os == 'Windows' && matrix.compiler == 'msvc'
        uses: TheMrMilchmann/setup-msvc-dev@v3  # sets VS dev cmd env
        with:
          arch: x64
      - name: Select clang (Windows)
        if: runner.os == 'Windows' && matrix.compiler == 'clang'
        run: |
          echo "CC=clang-cl" >> $env:GITHUB_ENV
          echo "CXX=clang-cl" >> $env:GITHUB_ENV

      - name: Install compilers (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            sudo apt-get install -y build-essential
            echo "CC=gcc" >> $GITHUB_ENV
            echo "CXX=g++" >> $GITHUB_ENV
          else
            sudo apt-get install -y clang lld
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi

      - name: Install compilers (macOS)
        if: runner.os == 'macOS'
        run: |
          if [ "${{ matrix.compiler }}" = "gcc" ]; then
            brew update
            brew install gcc
            # Homebrew gcc has a version suffix, pick the latest:
            G=$(brew list --versions gcc | awk '{print $2}' | tail -1 | cut -d. -f1)
            echo "CC=gcc-$G" >> $GITHUB_ENV
            echo "CXX=g++-$G" >> $GITHUB_ENV
          else
            echo "CC=clang" >> $GITHUB_ENV
            echo "CXX=clang++" >> $GITHUB_ENV
          fi

      - name: Bootstrap Test Suite (Windows)
        if: runner.os == 'Windows'
        run: clang -O0 -g -o run_tests.exe tests/run_test_suite.c

      - name: Run Test Suite (Windows)
        if: runner.os == 'Windows'
        run: run_tests.exe

      - name: Bootstrap Test Suite (POSIX)
        if: runner.os == 'macOS' || runner.os == 'Linux'
        run: clang -O0 -g -o run_tests tests/run_test_suite.c

      - name: Run Test Suite (POSIX)
        if: runner.os == 'macOS' || runner.os == 'Linux'
        run: ./run_tests
